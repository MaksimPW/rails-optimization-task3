# Case-study оптимизации

## Актуальная проблема

В нашем проекте возникла серьёзная проблема.

Страница расписаний формируется не эффективно, механизм перезагрузки расписаний из файла занимает очень много времени(больше минуты)

Нужно исправить это и сделать механизм перезагрузки расписаний быстрее, чтобы его обработка занимала меньше одной минуты

## Формирование метрики
Для того, чтобы понимать, дают ли мои изменения положительный эффект на быстродействие программы я придумал использовать такую метрику: время исполнения rake таски и страницы с рейсами

## Feedback-Loop
Для того, чтобы иметь возможность быстро проверять гипотезы я выстроил эффективный `feedback-loop`, который позволил мне получать обратную связь по эффективности сделанных изменений за N:

- пока не выстроил

## Вникаем в детали системы, чтобы найти главные точки роста
Для того, чтобы найти "точки роста" для оптимизации я воспользовался:

- пока ничем не воспользовался

Вот какие проблемы удалось найти и решить

### Ваша находка №0

Прогнал rake reload_json для всех файлов в fixtures, записал результаты
large.json отрабатывал слишком долго, не стал ждать
Буду ориентироваться на small.json, результат: 30 секунд

Решил сразу воспользоваться советом использовать гем `activerecord-import`

Поставил его, применил для импорта Trip
После прогона make reload_small время работы сократилось и составило 26 сек

### Ваша находка №1

Добавил в проект pghero, rack-mini-profiler, memory-profiler, bullet
Перенес код по импорту данных из rake task в отдельный интерактор ImportData
Написал rspec тесты

## Результаты

### rake reload_json

|                  |ДО                        |ПОСЛЕ                     |
|------------------|--------------------------|--------------------------|
| example.json     | 0.547757                 | -                        |
| large.json       | очень долго              | -                        |
| medium.json      | 229 сек                  | -                        |
| small.json       | 30 сек                   | -                        |

### Заметки

#### Совет: как посчитать кол-во строк в файле
```
wc -l data_large.rb # (3250940)  total line count
```

#### Совет: как создать меньший файл из большего, оставив перевые N строк
```
head -n N data_large.txt > dataN.txt
```

## Защита от регрессии производительности

Пока ничего не сделано