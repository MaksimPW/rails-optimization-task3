# Case-study оптимизации

## Актуальная проблема

В нашем проекте возникла серьёзная проблема.

Страница расписаний формируется не эффективно, механизм перезагрузки расписаний из файла занимает очень много времени(больше минуты)

## Задачи


### №1 Сократить время выполнения импорта данных

### №2

## Формирование метрики
Для того, чтобы понимать, дают ли мои изменения положительный эффект на быстродействие программы я придумал использовать такую метрику: время исполнения rake таски и страницы с рейсами

## Feedback-Loop
Для того, чтобы иметь возможность быстро проверять гипотезы я выстроил эффективный `feedback-loop`, который позволил мне получать обратную связь по эффективности сделанных изменений за N:

- пока не выстроил

## Вникаем в детали системы, чтобы найти главные точки роста
Для того, чтобы найти "точки роста" для оптимизации я воспользовался:

- пока ничем не воспользовался

Вот какие проблемы удалось найти и решить

### Ваша находка №0

Прогнал rake reload_json для всех файлов в fixtures, записал результаты
large.json отрабатывал слишком долго, не стал ждать
Буду ориентироваться на small.json, результат: 30 секунд

Решил сразу воспользоваться советом использовать гем `activerecord-import`

Поставил его, применил для импорта Trip
После прогона make reload_small время работы сократилось и составило 26 сек

### Ваша находка №1

Подготовка:

Добавил в проект
- pghero
- rack-mini-profiler
- memory-profiler
- bullet
- rspec-benchmark
- rspec-sqlimit

Перенес код по импорту данных из rake task в отдельный интерактор `ImportData`

Для того, чтобы лучше разобраться в коде и защитить его, написал rspec тесты и сделал рефакторинг

Профилирование:

С помощью тестов `rspec-sqlimit` смог увидеть количество запросов, которые я делаю в базу

Как оказалось, использовать `activerecord-import` только лишь для Trip было не так корректно, так как к другим таблицам все равно было очень много запросов.

Изменения:

Сделал хранение всей информации в хеше. Это позволит нам не делать так много запросов SELECT к базе, чтобы найти запись.

Использовал метод `import` из гема `activerecord-import` для других моделей:
Service, Bus, City

Результаты:

|                  |ДО                        |ПОСЛЕ                     |
|------------------|--------------------------|--------------------------|
| example.json     | 0.547757 сек             | 0.257931 сек             |
| large.json       | очень долго              | 56 сек                   |
| medium.json      | 229 сек                  | 10 сек                   |
| small.json       | 30 сек                   | 2.990186 сек             |

Выводы:

Нагрузка на выросла за счет того, что все данные стали хранится в хешах(MEMORY USAGE: 1067 MB)
Но я смог сократить время работы за счет уменьшения количества запросов в базу.
Так что по метрике задача №1 была выполнена

Думаю, что можно сократить и показатели по памяти, но тогда нужно будет отказаться от `activerecord-import` и стримить записи сразу в бд

## Результаты

### rake reload_json

|                  |ДО                        |ПОСЛЕ                     |
|------------------|--------------------------|--------------------------|
| example.json     | 0.547757                 | -                        |
| large.json       | очень долго              | -                        |
| medium.json      | 229 сек                  | -                        |
| small.json       | 30 сек                   | -                        |

### Заметки

#### Совет: как посчитать кол-во строк в файле
```
wc -l data_large.rb # (3250940)  total line count
```

#### Совет: как создать меньший файл из большего, оставив перевые N строк
```
head -n N data_large.txt > dataN.txt
```

## Защита от регрессии производительности

Пока ничего не сделано